<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Post</title>
  <link rel="stylesheet" href="/css/webix.min.css" type="text/css">
</head>
<body>
<script src="/js/webix.min.js" type="text/javascript"></script>
<script>
    webix.ready(function() {
        const datatable = {
            id: "mytable",
            view:"datatable",
            autoheight:true,
            minHeight:400,
            autowidth:true,
            editable:true,
            editaction:"dblclick",
            scroll:false,
            select:true,
            css:{
                "font-size": "20px",
            },
            columns: [
                {id: "id", header: "id", width: 50},
                {id: "title", header: "标题", width: 200,editor: "text"},
                {id: "body", header: "内容", width: 500,editor: "text"},
                {id: "update_time", header: "创建时间", width: 150, template:function(obj){return new Date(obj.update_time).toLocaleString()}}
            ],
            on:{
                onAfterEditStop: async function (state, editor, ignoreUpdate) {
                    if (ignoreUpdate) return;
                    // console.log(`更新后的值:${state.value},更新前的值:${state.old}`);
                    // console.log(`更的列名:${editor.column},id:${editor.row}`);
                    const params = {[editor.column]: state.value}
                    const response = await webix.ajax()
                        .headers({token: window.localStorage.getItem("token"),"Content-type":"application/json"})
                        .put("/api/post/"+editor.row,JSON.stringify(params))
                    const json = await response.json()
                    if (json.code !== 200) {
                        webix.alert(json.msg)
                    }
                }
            },
            url:async function () {
                const response = await webix.ajax().headers({token: window.localStorage.getItem("token")}).get("/api/post")
                const res = await response.json()
                if (res.code !== 200) {
                    webix.alert(res.msg)
                } else {
                    return res.data
                }
            },
            pager:"pager"
        };
        var insert_window = {
            view:"window",
            id:"insert_window",
            head:"新增",
            close:true,
            position: "center",
            body: {
                view:"form",
                id:"insert_form",
                elements:[
                    {view:"text", name:"title", label:"标题"},
                    {view:"textarea", name:"body",width:300, height:200, label:"内容"},
                    {view:"button", value:"提交", click:async function () {
                            const params = this.getParentView().getValues()
                            const response = await webix.ajax()
                                .headers({token: window.localStorage.getItem("token"),"Content-type":"application/json"})
                                .post("/api/post",JSON.stringify(params));
                            const json = await response.json()
                            if (json.code !== 200) {
                                webix.alert(json.msg)
                                return [];
                            } else {
                                this.getParentView().hide();
                                webix.message("新增成功");

                                const response = await webix.ajax().headers({token: window.localStorage.getItem("token")}).get("/api/post")
                                const res = await response.json()
                                if (res.code !== 200) {
                                    webix.alert(res.msg);
                                } else {
                                    $$("mytable").clearAll();
                                    $$("mytable").parse(res.data);
                                }
                            }
                        }}
                ]
            }
        };
        webix.ui({
            css:{
                margin:"50px auto",
            },
            width: 1000,
            rows: [
                {type: "header", template: "lxy博客"},
                {
                    view:"toolbar",
                    cols:[
                        {view:"button", value:"新增",width:100, click:function(){webix.ui(insert_window).show()}},
                    ]
                },
                datatable,
                {
                    view:"pager",
                    id:"pager",
                    size:10,
                    group:5,
                    template: "{common.prev()}{common.pages()}{common.next()}"
                }
            ]
        });
    })
</script>
</body>
</html>